<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ß–∏–∂–∏–∫ - –ü–æ–∏—Å–∫ –ø–æ–º–µ—â–µ–Ω–∏–π –Ω–∞ –ø—Ä–æ–¥–∞–∂—É –Ω–∞ –ê–≤–∏—Ç–æ</title>
    <script src="https://api-maps.yandex.ru/2.1/?apikey=a02e9c35-dadf-4b17-903a-4893c30c8b3e&lang=ru_RU" type="text/javascript"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #2d5016 0%, #4a7c59 50%, #6ba368 100%);
            min-height: 100vh;
            color: #333;
        }
        .container {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }
        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #2d5016, #4a7c59, #6ba368);
        }
        .header {
            text-align: center;
            color: #2d5016;
            margin-bottom: 30px;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 20px;
        }
        .header h1 {
            font-size: 2.8em;
            margin: 0;
            background: linear-gradient(45deg, #2d5016, #4a7c59, #6ba368);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 800;
        }
        .header p {
            color: #666;
            font-size: 1.1em;
            margin-top: 10px;
        }
        .status {
            padding: 18px;
            border-radius: 12px;
            margin: 20px 0;
            border-left: 5px solid;
            font-weight: 500;
        }
        .success { 
            background-color: #d4edda; 
            color: #155724; 
            border-left-color: #28a745;
        }
        .info { 
            background-color: #d1ecf1; 
            color: #0c5460; 
            border-left-color: #17a2b8;
        }
        .warning { 
            background-color: #fff3cd; 
            color: #856404; 
            border-left-color: #ffc107;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border-left-color: #dc3545;
        }

        button {
            background: linear-gradient(45deg, #2d5016, #4a7c59);
            color: white;
            padding: 14px 28px;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            margin: 10px 5px;
            font-weight: 600;
            font-size: 15px;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(45, 80, 22, 0.3);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        button:hover { 
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(45, 80, 22, 0.4);
            background: linear-gradient(45deg, #4a7c59, #6ba368);
        }
        button:active {
            transform: translateY(-1px);
        }
        button.primary {
            background: linear-gradient(45deg, #007bff, #0056b3);
            box-shadow: 0 6px 20px rgba(0, 123, 255, 0.3);
        }
        button.primary:hover {
            box-shadow: 0 8px 25px rgba(0, 123, 255, 0.4);
            background: linear-gradient(45deg, #0056b3, #004085);
        }

        .api-status {
            background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            border: 2px solid #4a7c59;
        }
        .api-key-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #ddd;
        }
        .api-key-item:last-child {
            border-bottom: none;
        }
        .api-key-name {
            font-weight: 600;
            color: #2d5016;
        }
        .api-key-value {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #666;
            background: #f8f9fa;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .search-and-map {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin: 30px 0;
        }

        .search-form {
            background: linear-gradient(135deg, #f8f9fa, #ffffff);
            padding: 30px;
            border-radius: 15px;
            border: 2px solid #dee2e6;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .search-form h3 {
            color: #2d5016;
            margin-top: 0;
            font-size: 1.4em;
        }
        .form-group {
            margin: 20px 0;
        }
        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #495057;
            font-size: 14px;
        }
        .form-group select, .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #ced4da;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }
        .form-group select:focus, .form-group input:focus {
            outline: none;
            border-color: #2d5016;
            box-shadow: 0 0 0 3px rgba(45, 80, 22, 0.1);
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .map-container {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            border: 2px solid #dee2e6;
        }
        .map-container h3 {
            color: #2d5016;
            margin-top: 0;
            text-align: center;
        }
        #yandex-map {
            width: 100%;
            height: 400px;
            border-radius: 10px;
        }

        #results {
            margin-top: 25px;
            padding: 25px;
            border-radius: 15px;
            max-height: 600px;
            overflow-y: auto;
        }
        .result-item {
            background: linear-gradient(135deg, #ffffff, #f8f9fa);
            padding: 20px;
            margin: 15px 0;
            border-radius: 12px;
            border-left: 5px solid #2d5016;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .result-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }
        .result-item.demo {
            border-left-color: #ffc107;
            background: linear-gradient(135deg, #fff9c4, #fff8e1);
        }
        .result-title {
            font-weight: 700;
            color: #2d5016;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        .result-details {
            color: #6c757d;
            font-size: 14px;
            line-height: 1.6;
        }
        .result-price {
            font-weight: bold;
            color: #28a745;
            font-size: 18px;
            margin: 8px 0;
        }
        .result-link {
            display: inline-block;
            margin-top: 12px;
            padding: 8px 16px;
            background: linear-gradient(45deg, #2d5016, #4a7c59);
            color: white;
            text-decoration: none;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .result-link:hover {
            background: linear-gradient(45deg, #4a7c59, #6ba368);
            transform: translateY(-1px);
        }

        .debug-info {
            background: #f1f3f4;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }

        @media (max-width: 968px) {
            .search-and-map {
                grid-template-columns: 1fr;
            }
            .form-row {
                grid-template-columns: 1fr;
            }
            .container {
                padding: 25px;
                margin: 10px;
            }
            .header h1 {
                font-size: 2.2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè™ –ß–∏–∂–∏–∫ - –ü–æ–∏—Å–∫ –ø–æ–º–µ—â–µ–Ω–∏–π –Ω–∞ –ø—Ä–æ–¥–∞–∂—É</h1>
            <p>–†–µ–∞–ª—å–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ê–≤–∏—Ç–æ API –∏ –∫–∞—Ä—Ç–∞–º–∏ –Ø–Ω–¥–µ–∫—Å</p>
        </div>

        <div class="status success">
            <strong>‚úÖ –°–∏—Å—Ç–µ–º–∞ —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π Avito API!</strong><br>
            –í–µ—Ä—Å–∏—è: 6.0.0 | –°—Ç–∞—Ç—É—Å: –†–µ–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ –∞–∫—Ç–∏–≤–µ–Ω | –†–µ–≥–∏–æ–Ω–æ–≤: 34 + –≤—Å–µ —Ä–µ–≥–∏–æ–Ω—ã | –¢–∏–ø: –ü—Ä–æ–¥–∞–∂–∞ –ø–æ–º–µ—â–µ–Ω–∏–π
        </div>

        <div class="api-status">
            <h3 style="text-align: center; margin-top: 0; color: #2d5016;">üîë –°—Ç–∞—Ç—É—Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π</h3>
            <div class="api-key-item">
                <span class="api-key-name">üó∫Ô∏è –Ø–Ω–¥–µ–∫—Å JavaScript API:</span>
                <span class="api-key-value">a02e9c35-dadf-4b17-903a-4893c30c8b3e</span>
            </div>
            <div class="api-key-item">
                <span class="api-key-name">üß© –Ø–Ω–¥–µ–∫—Å Tiles API:</span>
                <span class="api-key-value">37d973f4-24d9-45f9-aef5-1745f7a13e1d</span>
            </div>
            <div class="api-key-item">
                <span class="api-key-name">üè¢ –ê–≤–∏—Ç–æ API:</span>
                <span class="api-key-value">–†–µ–∞–ª—å–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∞–∫—Ç–∏–≤–Ω–∞</span>
            </div>
            <div style="text-align: center; margin-top: 15px; color: #28a745; font-weight: 600;">
                ‚úÖ –í—Å–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω—ã
            </div>
        </div>

        <h3>üéõÔ∏è –¢–µ—Å—Ç —Å–∏—Å—Ç–µ–º—ã:</h3>
        <button onclick="testHealth()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å Health</button>
        <button onclick="testAuth()" class="primary">–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ê–≤–∏—Ç–æ</button>
        <button onclick="testMap()" style="background: linear-gradient(45deg, #28a745, #20c997);">–¢–µ—Å—Ç –∫–∞—Ä—Ç—ã</button>

        <div class="search-and-map">
            <div class="search-form">
                <h3>üîç –ü–æ–∏—Å–∫ –ø–æ–º–µ—â–µ–Ω–∏–π –Ω–∞ –ø—Ä–æ–¥–∞–∂—É:</h3>

                <div class="form-group">
                    <label for="region">–†–µ–≥–∏–æ–Ω –ø–æ–∏—Å–∫–∞:</label>
                    <select id="region" required>
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–≥–∏–æ–Ω...</option>
                        <option value="all_regions" style="background-color: #e8f5e8; font-weight: bold;">üåç –í–°–ï –†–ï–ì–ò–û–ù–´ –†–û–°–°–ò–ò</option>
                        <optgroup label="üèõÔ∏è –û—Å–Ω–æ–≤–Ω—ã–µ —Ä–µ–≥–∏–æ–Ω—ã">
                            <option value="moscow">–ú–æ—Å–∫–≤–∞ –∏ –ú–æ—Å–∫–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
                            <option value="spb">–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥ –∏ –õ–û</option>
                            <option value="ekaterinburg">–°–≤–µ—Ä–¥–ª–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å (–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥)</option>
                            <option value="novosibirsk">–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
                            <option value="voronezh">–í–æ—Ä–æ–Ω–µ–∂—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
                            <option value="yaroslavl">–Ø—Ä–æ—Å–ª–∞–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
                        </optgroup>
                    </select>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="minArea">–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –ø–ª–æ—â–∞–¥—å (–∫–≤.–º):</label>
                        <input type="number" id="minArea" value="390" min="100" max="10000" required>
                        <small style="color: #666;">–°—Ç–∞–Ω–¥–∞—Ä—Ç –ß–∏–∂–∏–∫: –æ—Ç 390 –∫–≤.–º</small>
                    </div>
                    <div class="form-group">
                        <label for="maxArea">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø–ª–æ—â–∞–¥—å (–∫–≤.–º):</label>
                        <input type="number" id="maxArea" placeholder="–±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π" min="390" max="50000">
                        <small style="color: #666;">–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –ø–æ–∏—Å–∫–∞ –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π</small>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="maxPrice">–ú–∞–∫—Å. —Ü–µ–Ω–∞ (–º–ª–Ω —Ä—É–±):</label>
                        <input type="number" id="maxPrice" placeholder="–±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π" min="1" max="1000" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="sortBy">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:</label>
                        <select id="sortBy">
                            <option value="price_asc">–ü–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é —Ü–µ–Ω—ã</option>
                            <option value="price_desc">–ü–æ —É–±—ã–≤–∞–Ω–∏—é —Ü–µ–Ω—ã</option>
                            <option value="area_asc">–ü–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é –ø–ª–æ—â–∞–¥–∏</option>
                            <option value="area_desc">–ü–æ —É–±—ã–≤–∞–Ω–∏—é –ø–ª–æ—â–∞–¥–∏</option>
                            <option value="date_desc" selected>–ü–æ –¥–∞—Ç–µ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è</option>
                        </select>
                    </div>
                </div>

                <div class="form-group full-width">
                    <label>
                        <input type="checkbox" id="saleOnly" checked disabled> 
                        üè™ –ü–æ–∏—Å–∫ —Ç–æ–ª—å–∫–æ –Ω–∞ –ü–†–û–î–ê–ñ–£ (–Ω–µ –∞—Ä–µ–Ω–¥–∞)
                    </label>
                </div>

                <div class="form-group full-width">
                    <label>
                        <input type="checkbox" id="debugMode"> 
                        üîß –†–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏ (–ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏)
                    </label>
                </div>

                <button onclick="searchListings()" class="primary" style="width: 100%; margin-top: 20px; font-size: 18px; padding: 16px;">
                    üîç –ü–û–ò–°–ö –†–ï–ê–õ–¨–ù–´–• –û–ë–™–Ø–í–õ–ï–ù–ò–ô
                </button>
            </div>

            <div class="map-container">
                <h3>üó∫Ô∏è –ö–∞—Ä—Ç–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</h3>
                <div id="yandex-map"></div>
                <div id="map-status" style="text-align: center; margin-top: 10px; color: #666; font-size: 14px;">
                    –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã...
                </div>
            </div>
        </div>

        <div id="results"></div>
    </div>

    <script>
        let currentAccessToken = null;
        let yandexMap = null;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã –Ø–Ω–¥–µ–∫—Å
        ymaps.ready(function () {
            try {
                yandexMap = new ymaps.Map('yandex-map', {
                    center: [55.751244, 37.618423], // –ú–æ—Å–∫–≤–∞
                    zoom: 5,
                    controls: ['zoomControl', 'fullscreenControl', 'geolocationControl']
                });

                document.getElementById('map-status').innerHTML = 
                    '<span style="color: #28a745;">‚úÖ –ö–∞—Ä—Ç–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ —Å API –∫–ª—é—á–æ–º</span>';

                console.log('Yandex Maps successfully initialized');
            } catch (error) {
                document.getElementById('map-status').innerHTML = 
                    '<span style="color: #dc3545;">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã: ' + error.message + '</span>';
                console.error('Yandex Maps initialization error:', error);
            }
        });

        async function testHealth() {
            try {
                const response = await fetch('/api/health');
                const data = await response.json();
                document.getElementById('results').innerHTML = 
                    '<div class="status success"><strong>‚úÖ Health Check —É—Å–ø–µ—à–µ–Ω:</strong><br><pre>' + JSON.stringify(data, null, 2) + '</pre></div>';
            } catch (error) {
                document.getElementById('results').innerHTML = 
                    '<div class="status error"><strong>‚ùå –û—à–∏–±–∫–∞ Health Check:</strong> ' + error.message + '</div>';
            }
        }

        async function testAuth() {
            try {
                document.getElementById('results').innerHTML = 
                    '<div class="status info"><strong>üîÑ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ê–≤–∏—Ç–æ API...</strong><br>–ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω –¥–æ—Å—Ç—É–ø–∞...</div>';

                const response = await fetch('/api/auth', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({grant_type: 'client_credentials'})
                });
                const data = await response.json();

                if (data.success && data.access_token) {
                    currentAccessToken = data.access_token;
                    document.getElementById('results').innerHTML = 
                        '<div class="status success"><strong>‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ê–≤–∏—Ç–æ —É—Å–ø–µ—à–Ω–∞!</strong><br>' +
                        '–¢–æ–∫–µ–Ω –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω ' + Math.round(data.expires_in / 3600) + ' —á–∞—Å–æ–≤<br>' +
                        '–¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –∏—Å–∫–∞—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –Ω–∞ –ê–≤–∏—Ç–æ<br>' +
                        '<pre>' + JSON.stringify(data, null, 2) + '</pre></div>';
                } else {
                    document.getElementById('results').innerHTML = 
                        '<div class="status error"><strong>‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ê–≤–∏—Ç–æ:</strong><br><pre>' + JSON.stringify(data, null, 2) + '</pre></div>';
                }
            } catch (error) {
                document.getElementById('results').innerHTML = 
                    '<div class="status error"><strong>‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:</strong> ' + error.message + '</div>';
            }
        }

        function testMap() {
            if (yandexMap) {
                // –û—á–∏—â–∞–µ–º –∫–∞—Ä—Ç—É
                yandexMap.geoObjects.removeAll();

                // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—É—é –º–µ—Ç–∫—É
                const testPlacemark = new ymaps.Placemark([55.751244, 37.618423], {
                    balloonContent: '<strong>‚úÖ –¢–µ—Å—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π –ø—Ä–æ—à–µ–ª —É—Å–ø–µ—à–Ω–æ!</strong><br>' +
                                   '–ö–∞—Ä—Ç—ã –Ø–Ω–¥–µ–∫—Å: –ê–∫—Ç–∏–≤–Ω—ã<br>' +
                                   '–ê–≤–∏—Ç–æ API: ' + (currentAccessToken ? '–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω' : '–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è') + '<br>' +
                                   'JavaScript API: a02e9c35-dadf-4b17-903a-4893c30c8b3e'
                }, {
                    preset: 'islands#greenDotIcon'
                });

                yandexMap.geoObjects.add(testPlacemark);
                yandexMap.setCenter([55.751244, 37.618423], 10, { duration: 1000 });

                document.getElementById('results').innerHTML = 
                    '<div class="status success"><strong>‚úÖ –¢–µ—Å—Ç –∫–∞—Ä—Ç—ã –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π —É—Å–ø–µ—à–µ–Ω!</strong><br>' +
                    'üó∫Ô∏è –ö–∞—Ä—Ç—ã –Ø–Ω–¥–µ–∫—Å: –†–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ<br>' +
                    'üîë API –∫–ª—é—á–∏: –ü–æ–¥–∫–ª—é—á–µ–Ω—ã –∏ –∞–∫—Ç–∏–≤–Ω—ã<br>' +
                    'üè¢ –ê–≤–∏—Ç–æ API: ' + (currentAccessToken ? '–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, –≥–æ—Ç–æ–≤ –∫ –ø–æ–∏—Å–∫—É' : '–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è') + '<br>' +
                    '–î–æ–±–∞–≤–ª–µ–Ω–∞ —Ç–µ—Å—Ç–æ–≤–∞—è –º–µ—Ç–∫–∞ –≤ —Ü–µ–Ω—Ç—Ä–µ –ú–æ—Å–∫–≤—ã.</div>';
            } else {
                document.getElementById('results').innerHTML = 
                    '<div class="status error"><strong>‚ùå –ö–∞—Ä—Ç–∞ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞!</strong><br>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ API –∫–ª—é—á–∏ –Ø–Ω–¥–µ–∫—Å –∫–∞—Ä—Ç.</div>';
            }
        }

        async function searchListings() {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            if (!currentAccessToken) {
                document.getElementById('results').innerHTML = 
                    '<div class="status warning"><strong>‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ê–≤–∏—Ç–æ!</strong><br>' +
                    '–°–Ω–∞—á–∞–ª–∞ –Ω–∞–∂–º–∏—Ç–µ "–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ê–≤–∏—Ç–æ" –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ä–µ–∞–ª—å–Ω—ã–º –æ–±—ä—è–≤–ª–µ–Ω–∏—è–º.</div>';
                return;
            }

            // –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö —Ñ–æ—Ä–º—ã
            const region = document.getElementById('region').value;
            const minArea = parseInt(document.getElementById('minArea').value) || 390;
            const maxArea = document.getElementById('maxArea').value ? parseInt(document.getElementById('maxArea').value) : null;
            const maxPrice = document.getElementById('maxPrice').value;
            const sortBy = document.getElementById('sortBy').value;
            const debugMode = document.getElementById('debugMode').checked;

            if (!region) {
                document.getElementById('results').innerHTML = 
                    '<div class="status warning"><strong>‚ö†Ô∏è –í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–≥–∏–æ–Ω!</strong></div>';
                return;
            }

            // –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
            const filters = {
                min_area: minArea,
                max_area: maxArea,
                deal_type: "sale",
                sort_by: sortBy,
                debug_mode: debugMode
            };

            if (maxPrice) filters.max_price = parseFloat(maxPrice) * 1000000; // –º–ª–Ω –≤ —Ä—É–±–ª–∏

            const regionName = region === 'all_regions' ? '–í—Å–µ —Ä–µ–≥–∏–æ–Ω—ã –†–æ—Å—Å–∏–∏' : 
                              document.getElementById('region').selectedOptions[0].text;

            // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É
            if (yandexMap) {
                const coords = region === 'all_regions' ? [55.751244, 37.618423] : 
                              region === 'moscow' ? [55.7558, 37.6176] :
                              region === 'spb' ? [59.9311, 30.3609] :
                              region === 'ekaterinburg' ? [56.8431, 60.6454] :
                              region === 'novosibirsk' ? [55.0084, 82.9357] :
                              [55.751244, 37.618423];
                const zoom = region === 'all_regions' ? 3 : 9;
                yandexMap.setCenter(coords, zoom, { duration: 1000 });
            }

            document.getElementById('results').innerHTML = 
                '<div class="status info"><strong>üîç –ü–æ–∏—Å–∫ –†–ï–ê–õ–¨–ù–´–• –æ–±—ä—è–≤–ª–µ–Ω–∏–π –Ω–∞ –ê–≤–∏—Ç–æ...</strong><br>' +
                'üè¢ –†–µ–≥–∏–æ–Ω: ' + regionName + '<br>' +
                'üìê –ü–ª–æ—â–∞–¥—å: –æ—Ç ' + minArea + (maxArea ? ' –¥–æ ' + maxArea : '') + ' –∫–≤.–º<br>' +
                'üí∞ –¢–∏–ø —Å–¥–µ–ª–∫–∏: –ü–û–ö–£–ü–ö–ê –ø–æ–º–µ—â–µ–Ω–∏—è (–∫–æ–º–º–µ—Ä—á–µ—Å–∫–∞—è –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å)<br>' +
                'üìä –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: ' + document.getElementById('sortBy').selectedOptions[0].text + '<br>' +
                'üîß –û—Ç–ª–∞–¥–∫–∞: ' + (debugMode ? '–≤–∫–ª—é—á–µ–Ω–∞' : '–≤—ã–∫–ª—é—á–µ–Ω–∞') + '<br>' +
                '–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∑–∞–ø—Ä–æ—Å –∫ –ê–≤–∏—Ç–æ API...</div>';

            try {
                const response = await fetch('/api/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        region: region,
                        filters: filters,
                        access_token: currentAccessToken,
                        search_type: 'real_avito_search'
                    })
                });

                const data = await response.json();
                console.log('Search API response:', data);

                if (data.success) {
                    displaySearchResults(data, debugMode);
                    updateMapWithResults(data.results);
                } else {
                    document.getElementById('results').innerHTML = 
                        '<div class="status error"><strong>‚ùå –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:</strong><br>' +
                        '<pre>' + JSON.stringify(data, null, 2) + '</pre></div>';
                }
            } catch (error) {
                console.error('Search request error:', error);
                document.getElementById('results').innerHTML = 
                    '<div class="status error"><strong>‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ API:</strong><br>' +
                    error.message + '</div>';
            }
        }

        function displaySearchResults(data, debugMode = false) {
            const isDemo = data.search_source === 'demo_fallback';
            const isReal = data.search_source === 'real_avito_api';

            const sourceInfo = isReal ? 
                'üéØ –ò—Å—Ç–æ—á–Ω–∏–∫: –†–ï–ê–õ–¨–ù–´–ï –æ–±—ä—è–≤–ª–µ–Ω–∏—è —Å –ê–≤–∏—Ç–æ' :
                'üé≠ –ò—Å—Ç–æ—á–Ω–∏–∫: –î–µ–º–æ-–¥–∞–Ω–Ω—ã–µ (–ê–≤–∏—Ç–æ API –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ)';

            const statusClass = isReal ? 'success' : 'warning';

            let resultsHtml = `
                <div class="status ${statusClass}">
                    <strong>${isReal ? '‚úÖ' : '‚ö†Ô∏è'} –ü–æ–∏—Å–∫ –ø–æ–º–µ—â–µ–Ω–∏–π –Ω–∞ –ü–†–û–î–ê–ñ–£ –∑–∞–≤–µ—Ä—à–µ–Ω!</strong><br>
                    ${sourceInfo}<br>
                    –ù–∞–π–¥–µ–Ω–æ –æ–±—ä—è–≤–ª–µ–Ω–∏–π: <strong>${data.total_count}</strong> –≤ —Ä–µ–≥–∏–æ–Ω–µ <strong>${data.region}</strong><br>
                    –¢–∏–ø —Å–¥–µ–ª–∫–∏: <strong>–ü–†–û–î–ê–ñ–ê</strong> –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–π –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏<br>
                    –ü–ª–æ—â–∞–¥—å: –æ—Ç ${data.filters_applied?.min_area || 390}${data.filters_applied?.max_area ? ' –¥–æ ' + data.filters_applied.max_area : ''} –∫–≤.–º<br>
                    –í—Ä–µ–º—è –ø–æ–∏—Å–∫–∞: ${new Date(data.timestamp).toLocaleString('ru-RU')}
                </div>
            `;

            if (isDemo && data.error_message) {
                resultsHtml += `
                    <div class="status info">
                        <strong>‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</strong><br>
                        ${data.error_message}<br>
                        ${data.suggestion}
                    </div>
                `;
            }

            resultsHtml += data.results.map(item => `
                <div class="result-item ${item.is_demo ? 'demo' : ''}" onclick="focusOnMap([${item.coordinates.lat}, ${item.coordinates.lon}])">
                    <div class="result-title">
                        ${item.is_real ? 'üè¢' : 'üé≠'} ${item.title}
                        ${item.is_demo ? ' <span style="color: #ffc107; font-size: 12px;">(–î–ï–ú–û)</span>' : ''}
                    </div>
                    <div class="result-price">üí∞ ${item.price.value.toLocaleString('ru-RU')} ‚ÇΩ (–ü–†–û–î–ê–ñ–ê)</div>
                    <div class="result-details">
                        üìç <strong>–ê–¥—Ä–µ—Å:</strong> ${item.address}<br>
                        üìê <strong>–ü–ª–æ—â–∞–¥—å:</strong> ${item.area} –∫–≤.–º<br>
                        üíµ <strong>–¶–µ–Ω–∞ –∑–∞ –∫–≤.–º:</strong> ${Math.round(item.price.value / item.area).toLocaleString('ru-RU')} ‚ÇΩ/–∫–≤.–º<br>
                        üè¢ <strong>–≠—Ç–∞–∂:</strong> ${item.floor || '–Ω–µ —É–∫–∞–∑–∞–Ω'}<br>
                        üö™ <strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> ${item.description}<br>
                        üìÖ <strong>–†–∞–∑–º–µ—â–µ–Ω–æ:</strong> ${new Date(item.created_at).toLocaleDateString('ru-RU')}<br>
                        üë§ <strong>–ü—Ä–æ–¥–∞–≤–µ—Ü:</strong> ${item.seller_type}<br>
                        üó∫Ô∏è <strong>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã:</strong> ${item.coordinates.lat.toFixed(4)}, ${item.coordinates.lon.toFixed(4)}<br>
                        üîó <strong>–ò—Å—Ç–æ—á–Ω–∏–∫:</strong> ${item.is_real ? '–†–µ–∞–ª—å–Ω–æ–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ –ê–≤–∏—Ç–æ' : '–î–µ–º–æ-–¥–∞–Ω–Ω—ã–µ'}
                    </div>
                    <a href="${item.url}" target="_blank" class="result-link" onclick="event.stopPropagation();">
                        ${item.is_demo ? 'üé≠ –î–µ–º–æ-—Å—Å—ã–ª–∫–∞' : 'üîó –û—Ç–∫—Ä—ã—Ç—å –Ω–∞ –ê–≤–∏—Ç–æ'} ‚Üí
                    </a>
                </div>
            `).join('');

            if (debugMode && data.debug_info) {
                resultsHtml += `
                    <div class="debug-info">
                        <strong>üîß –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</strong><br>
                        <pre>${JSON.stringify(data.debug_info, null, 2)}</pre>
                    </div>
                `;
            }

            document.getElementById('results').innerHTML = resultsHtml;
        }

        function updateMapWithResults(results) {
            if (!yandexMap || !results || results.length === 0) return;

            // –û—á–∏—â–∞–µ–º –∫–∞—Ä—Ç—É
            yandexMap.geoObjects.removeAll();

            // –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–∫–∏ –Ω–∞ –∫–∞—Ä—Ç—É
            results.forEach((item, index) => {
                const placemark = new ymaps.Placemark([item.coordinates.lat, item.coordinates.lon], {
                    balloonContent: `
                        <strong>${item.title}</strong><br>
                        <strong>–¶–µ–Ω–∞:</strong> ${item.price.value.toLocaleString('ru-RU')} ‚ÇΩ<br>
                        <strong>–ü–ª–æ—â–∞–¥—å:</strong> ${item.area} –∫–≤.–º<br>
                        <strong>–ê–¥—Ä–µ—Å:</strong> ${item.address}<br>
                        <strong>–ò—Å—Ç–æ—á–Ω–∏–∫:</strong> ${item.is_real ? '–†–µ–∞–ª—å–Ω–æ–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ' : '–î–µ–º–æ-–¥–∞–Ω–Ω—ã–µ'}<br>
                        <a href="${item.url}" target="_blank">–û—Ç–∫—Ä—ã—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</a>
                    `
                }, {
                    preset: item.is_real ? 'islands#redDotIcon' : 'islands#yellowDotIcon'
                });

                yandexMap.geoObjects.add(placemark);
            });

            // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É –ø–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º
            if (results.length > 0) {
                yandexMap.setBounds(yandexMap.geoObjects.getBounds(), { checkZoomRange: true });
            }
        }

        function focusOnMap(coordinates) {
            if (yandexMap) {
                yandexMap.setCenter(coordinates, 15, { duration: 500 });
            }
        }

        // –ü—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–Ω–∞—á–µ–Ω–∏–π
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('minArea').value = 390;
            document.getElementById('saleOnly').checked = true;
        });
    </script>
</body>
</html>